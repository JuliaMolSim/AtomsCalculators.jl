<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Interface · AtomsCalculators.jl</title><meta name="title" content="Interface · AtomsCalculators.jl"/><meta property="og:title" content="Interface · AtomsCalculators.jl"/><meta property="twitter:title" content="Interface · AtomsCalculators.jl"/><meta name="description" content="Documentation for AtomsCalculators.jl."/><meta property="og:description" content="Documentation for AtomsCalculators.jl."/><meta property="twitter:description" content="Documentation for AtomsCalculators.jl."/><meta property="og:url" content="https://JuliaMolSim.github.io/AtomsCalculators.jl/interface/"/><meta property="twitter:url" content="https://JuliaMolSim.github.io/AtomsCalculators.jl/interface/"/><link rel="canonical" href="https://JuliaMolSim.github.io/AtomsCalculators.jl/interface/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">AtomsCalculators.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Interface</a><ul class="internal"><li><a class="tocitem" href="#highlevelinterface"><span>High-Level Interface</span></a></li><li><a class="tocitem" href="#Low-Level-Interface"><span>Low-Level Interface</span></a></li><li><a class="tocitem" href="#keywordargs"><span>Recommended Keyword Arguments</span></a></li></ul></li><li><a class="tocitem" href="../utilities/">Utilities</a></li><li><a class="tocitem" href="../example/">Example</a></li><li><a class="tocitem" href="../api/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Interface</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Interface</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaMolSim/AtomsCalculators.jl/blob/master/docs/src/interface.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Interface-Definition"><a class="docs-heading-anchor" href="#Interface-Definition">Interface Definition</a><a id="Interface-Definition-1"></a><a class="docs-heading-anchor-permalink" href="#Interface-Definition" title="Permalink"></a></h1><p>The <code>AtomsCalculator</code> interface is designed to provide easy to use and easy to read high level functions for standard molecular mechanics, while at the same time being flexible and extensible. Moreover the flexible low-level interface is designed to be compatible with <a href="https://lux.csail.mit.edu/stable/"><code>Lux.jl</code></a> to enable training of parameterized models. Due to this tension (ease of use vs flexibility) there are two alternative ways to call and implement the interface, which are described in separate sections below. </p><p>A new calculator need not implement the entire interface, or indeed both interfaces to be useful. Moreover, <code>AtomsCalculators</code> provides <a href="../utilities/">various utilities</a> to help with the implementation.</p><p>Most interface functions have two common inputs: an <code>AtomsBase.AbstractSystem{D}</code> compatible structure and a &quot;calculator&quot; that specifies details of the calculation method. Throughout this documentation: </p><ul><li><code>sys</code> : always specifies a system, usually an <code>AtomsBase.AbstractSystem{D}</code></li><li><code>calc</code> : always specifies a calculator implementing (part of) the <code>AtomsCalculators</code> interface. </li></ul><h2 id="highlevelinterface"><a class="docs-heading-anchor" href="#highlevelinterface">High-Level Interface</a><a id="highlevelinterface-1"></a><a class="docs-heading-anchor-permalink" href="#highlevelinterface" title="Permalink"></a></h2><p>The high-level interface provides function prototypes for potential energy, forces and <a href="https://en.wikipedia.org/wiki/Virial_stress">virial</a> calculations.</p><h3 id="Minimal-high-level-interface"><a class="docs-heading-anchor" href="#Minimal-high-level-interface">Minimal high-level interface</a><a id="Minimal-high-level-interface-1"></a><a class="docs-heading-anchor-permalink" href="#Minimal-high-level-interface" title="Permalink"></a></h3><p>A minimal implementation of an <code>AtomsCalculators</code> calculator should provide (however, see alternatives below)</p><ul><li><a href="../api/#AtomsCalculators.energy_unit"><code>energy_unit(calc)</code></a> : return energy unit used by the calculator</li><li><a href="../api/#AtomsCalculators.length_unit"><code>length_unit(calc)</code></a> : return length unit used by the calculator</li><li><a href="../api/#AtomsCalculators.potential_energy"><code>potential_energy(sys, calc; kwargs...)</code></a> : return potential energy of the system as a <code>Unitful.Energy</code></li><li><a href="../api/#AtomsCalculators.forces"><code>forces(sys, calc; kwargs...)</code></a> return forces as an <code>AbstractVector{SVector{D, &lt;: Unitful.Force}}</code></li><li><a href="../api/#AtomsCalculators.virial"><code>virial(sys, calc; kwargs...)</code></a> return virial (not stress!) as a <code>SMatrix{D, D, Unitful.Energy}</code></li></ul><h4 id="Remarks"><a class="docs-heading-anchor" href="#Remarks">Remarks</a><a id="Remarks-1"></a><a class="docs-heading-anchor-permalink" href="#Remarks" title="Permalink"></a></h4><ul><li>Methods must accept keyword arguments, but they can be ignored. For a discussion of some standard keyword arguments that a calculator may wish to support see <a href="#keywordargs">Reserved Keyword Arguments</a>. </li><li>If a calculator does not implement a function, then it can simply choose not to provide that method. A simulator that relies on that function will then simply fail. For example a QM/MM force mixing scheme may be unable to provide <code>potential_energy</code>. </li></ul><h3 id="Extended-high-level-interface"><a class="docs-heading-anchor" href="#Extended-high-level-interface">Extended high-level interface</a><a id="Extended-high-level-interface-1"></a><a class="docs-heading-anchor-permalink" href="#Extended-high-level-interface" title="Permalink"></a></h3><p>The extended interface can be automatically generated from the minimal interface, but for various reasons (in particular performance), some calculators may prefer to implement their own methods for the following functions.</p><p>Several utility functions are derived from <code>energy_unit</code> and <code>length_unit</code> which can be overloaded by a calculator implementation: </p><ul><li><a href="../api/#AtomsCalculators.force_unit-Tuple{Any}"><code>force_unit(calc)</code></a> : compute force unit (default from energy and length units)</li><li><a href="../api/#AtomsCalculators.promote_force_type-Union{Tuple{D}, Tuple{AtomsBase.AbstractSystem{D}, Any}} where D"><code>promote_force_type(sys, calc)</code></a> : determine type of force</li><li><a href="../api/#AtomsCalculators.zero_energy-Tuple{Any, Any}"><code>zero_energy(sys, calc)</code></a> : initialize potential energy </li><li><a href="../api/#AtomsCalculators.zero_forces-Tuple{Any, Any}"><code>zero_forces(sys, calc)</code></a> : initilize a force vector </li><li><a href="../api/#AtomsCalculators.zero_virial-Tuple{Any, Any}"><code>zero_virial(sys, calc)</code></a> : initialize a virial matrix </li></ul><p>A calculator may provide non-allocating and or combined calculations that can sometimes be preferred for performance reasons. All of these return results as a <code>NamedTuple</code>.</p><ul><li><a href="../api/#AtomsCalculators.energy_forces-Tuple{Any, Any}"><code>energy_forces(sys, calc)</code></a></li><li><a href="../api/#AtomsCalculators.energy_forces!-Tuple{AbstractVector, Any, Any}"><code>energy_forces!(f, sys, calc)</code></a></li><li><a href="../api/#AtomsCalculators.energy_forces_virial-Tuple{Any, Any}"><code>energy_forces_virial(sys, calc)</code></a></li><li><a href="../api/#AtomsCalculators.energy_forces_virial!-Tuple{AbstractVector, Any, Any}"><code>energy_forces_virial!(f, sys, calc)</code></a></li></ul><p>To avoid writing too much boiler-plate code to support the full interface, see the <a href="../utilities/">utilities section</a> of the docs. </p><h2 id="Low-Level-Interface"><a class="docs-heading-anchor" href="#Low-Level-Interface">Low-Level Interface</a><a id="Low-Level-Interface-1"></a><a class="docs-heading-anchor-permalink" href="#Low-Level-Interface" title="Permalink"></a></h2><p>All high-level functionality listed above can also be accessed via &quot;low-level&quot; calls with user-specifiable parameters through <code>calculate</code> methods. The low-level <code>calculate</code> interface follows the <a href="https://lux.csail.mit.edu/stable/">Lux</a> model for parameters and state. This means that when calculations are performed with the <code>calculate</code> interface calculators <strong>must act as immutable</strong> structs that are passed  to the <code>calculate</code> function together with <code>parameters</code> and <code>state</code>. All calculations then return an output and a state. Note, we only require calculators <strong>act</strong> immutable but not to be technically immutable. For example the same calculator can implement the high-level interface and then mutate an internal state.</p><h3 id="General-structure-of-the-low-level-interface"><a class="docs-heading-anchor" href="#General-structure-of-the-low-level-interface">General structure of the low-level interface</a><a id="General-structure-of-the-low-level-interface-1"></a><a class="docs-heading-anchor-permalink" href="#General-structure-of-the-low-level-interface" title="Permalink"></a></h3><p>The low level interface is built around a <code>calculate</code> function </p><ul><li><a href="../api/#AtomsCalculators.calculate"><code>calculate(property, sys, calc, ps, st; kwargs...)</code></a></li></ul><p>where,</p><ul><li><code>property</code> is the property to be computed e.g. <code>PotentialEnergy()</code>,</li><li><code>sys</code> is an system, </li><li><code>calc</code> is a calculator, </li><li><code>ps</code> either <code>nothing</code> or a nested <code>NamedTuple</code> storing the calculator parameters,</li><li><code>st</code> either <code>nothing</code> or a nested <code>NamedTuple</code> storing the calculator state</li><li><code>kwargs...</code> must be allowed but can be ignored; with caveats - see <a href="#keywordargs">Reserved Keyword Arguments</a></li></ul><p>Irrespective of which property is required, the return type is <em>always</em> a <code>NamedTuple</code> with keys indicating the name of properties being computed. The content of this <code>NamedTuple</code> is not required to be restricted to the requested property (or, properties - more on this below). </p><h3 id="Calculator-State-and-Parameters"><a class="docs-heading-anchor" href="#Calculator-State-and-Parameters">Calculator State and Parameters</a><a id="Calculator-State-and-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Calculator-State-and-Parameters" title="Permalink"></a></h3><p>To manage parameters and state, <code>AtomsCalculators</code> provides prototypes that can be overloaded:</p><ul><li><a href="../api/#AtomsCalculators.get_state-Tuple{Any}"><code>get_state(calc)</code></a> : return a <code>NamedTuple</code> or <code>ComponentArray</code> containing the entire mutable state of the calculator;</li><li><a href="../api/#AtomsCalculators.set_state!-Tuple{Any, Any}"><code>set_state!(calc, st)</code></a> : set the state of the calculator, may be mutating or non-mutating;</li><li><a href="../api/#AtomsCalculators.get_parameters-Tuple{Any}"><code>get_parameters(calc)</code></a> : return a <code>NamedTuple</code> or <code>ComponentArray</code> containing all parameters;</li><li><a href="../api/#AtomsCalculators.set_parameters!-Tuple{Any, Any}"><code>set_parameters!(calc, ps)</code></a> : set the parameters of the calculator, may be mutating or non-mutating.</li></ul><p>This functionality is somewhat separate from Lux</p><pre><code class="language-julia hljs">ps, st = Lux.setup(rng, model)
ps = LuxCore.initparameters(rng, model)</code></pre><p>The difference is that <code>Lux.setup</code> initializes parameters, whereas, <code>*_state</code> and <code>*_parameters</code> is intended to read and write existing (already fitted) parameters.  In addition, a calculator need not implement <code>LuxCore.initparams</code> and <code>LuxCore.initstate</code>, but it has the option to do so.</p><p>The default implementations for <code>*_state</code> and <code>*_parameters</code> assume a stateless and parameter-free calculator.</p><p>The calls <code>set_state!</code> and <code>set_parameters!</code> may be mutating (hence the !) but need not be mutating. The correct usage is therefore </p><pre><code class="language-julia hljs">new_calc = set_state!(calc, st) 
new_calc = set_parameters!(calc, ps)</code></pre><p>In general, the caller should not assume that <code>new_calc</code> and <code>calc</code> are references to the same object.</p><h3 id="Molecular-mechanics-with-the-low-level-interface"><a class="docs-heading-anchor" href="#Molecular-mechanics-with-the-low-level-interface">Molecular mechanics with the low-level interface</a><a id="Molecular-mechanics-with-the-low-level-interface-1"></a><a class="docs-heading-anchor-permalink" href="#Molecular-mechanics-with-the-low-level-interface" title="Permalink"></a></h3><p>The three basic properties to perform molecular mechanics simulations are energy, forces and virials, defined through</p><ul><li><a href="../api/#AtomsCalculators.Energy"><code>Energy()</code></a></li><li><a href="../api/#AtomsCalculators.Forces"><code>Forces()</code></a></li><li><a href="../api/#AtomsCalculators.Virial"><code>Virial()</code></a></li></ul><p>With these properties, the following calling conventions are analogous: </p><ul><li><code>calculate(Energy(), sys, calc, ps, st)</code> is analogous to <code>potential_energy(sys, calc)</code></li><li><code>calculate(Forces(), sys, calc, ps, st)</code> is analogous to <code>forces(sys, calc)</code></li><li><code>calculate(Virial(), sys, calc, ps, st)</code> is analogous to <code>virial(sys, calc)</code></li></ul><p>Energies, forces and virials can be obtained from the output <code>NamedTuple</code> via </p><pre><code class="language-julia hljs">out = calculate(Energy(), sys, calc, ps, st)
out.energy 
out = calculate(Forces(), sys, calc, ps, st)
out.forces
out = calculate(Virial(), sys, calc, ps, st)
out.virial </code></pre><h3 id="Multiple-properties"><a class="docs-heading-anchor" href="#Multiple-properties">Multiple properties</a><a id="Multiple-properties-1"></a><a class="docs-heading-anchor-permalink" href="#Multiple-properties" title="Permalink"></a></h3><p>Multiple properties can be requested from a calculator by bundling them into a tuple. For example, </p><pre><code class="language-julia hljs">efv = calculate( (Energy(), Forces(), Virial()), sys, calc, ps, st)
efv.energy 
efv.forces 
efv.virial </code></pre><h3 id="Extensions"><a class="docs-heading-anchor" href="#Extensions">Extensions</a><a id="Extensions-1"></a><a class="docs-heading-anchor-permalink" href="#Extensions" title="Permalink"></a></h3><p>A calculator can extend the <code>calculate</code> interface without having to make a pull request to <code>AtomsCalculators</code>. For example, a site potential could supply the possibility of returning site energies, which could be implemented as follows. </p><pre><code class="language-julia hljs">struct SiteEnergies end 
out = calculate(SiteEnergies(), sys, calc, ps, st)
out.siteenergies::AbstractVector{&lt;: Unitful.Energy}</code></pre><p>If such an extension could be of value to a broader developer or user base, then an issue and/or PR to AtomsCalculators would be very welcome. </p><h2 id="keywordargs"><a class="docs-heading-anchor" href="#keywordargs">Recommended Keyword Arguments</a><a id="keywordargs-1"></a><a class="docs-heading-anchor-permalink" href="#keywordargs" title="Permalink"></a></h2><p>The following keyword arguments are used consistently throughout the AtomsBase / AtomsCalculators ecosystem. </p><ul><li><code>domain</code> : the domain over which to evaluate an energy, normally used for site potentials where partial energies can be evaluated. Calculators that do not provide this functionality may wish to throw an error is a partial energy is requested to avoid silent bugs. </li><li><code>executor</code> : a label or type specifying how to execute the calculator (e.g. in serial, multi-threaded, distributed)</li><li><code>nlist</code> : a possibly precomputed neighbourlist</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../utilities/">Utilities »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Friday 5 July 2024 17:03">Friday 5 July 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
